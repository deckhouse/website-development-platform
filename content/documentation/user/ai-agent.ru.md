---
title: AI-агент
---

{{< alert level="warning" >}}
Экспериментальный функционал
{{< /alert >}}

AI-агент — это интеллектуальный помощник, встроенный в Deckhouse Development Platform. Он отвечает на вопросы о платформе, анализирует данные каталога и выполняет различные задачи с использованием инструментов MCP (Model Context Protocol).
AI-агент использует настраиваемые AI-провайдеры для обработки запросов и может работать с различными языковыми моделями, включая OpenAI GPT, Ollama и любые модели, доступные через совместимый REST API.

## Настройка AI-провайдеров

### Типы провайдеров

Платформа поддерживает три типа AI-провайдеров:

1. **OpenAI** — для работы с моделями OpenAI (GPT-4, GPT-3.5 и др.).
1. **Ollama** — для работы с локальными моделями через Ollama.
1. **Custom** — для работы с любым кастомным REST API, совместимым с форматом запросов/ответов AI-агента.

### Учетные данные для провайдеров

Для безопасного хранения токенов и ключей доступа к AI-провайдерам используется система учетных данных. Учетные данные шифруются и хранятся в базе данных, а в заголовки запросов к AI-провайдерам передаются через механизм шаблонизации.

#### Добавление учетных данных

Для добавления новых учетных данных для AI-провайдеров:

1. В форме создания или редактирования провайдера нажмите кнопку **Управление учетными данными**.
1. В открывшемся диалоге нажмите **Добавить учетные данные**.
1. Введите пару ключ-значение:
   - **Ключ**: название ключа учетных данных (например, `api_key`, `openai_token`, `bearer_token`).
   - **Значение**: сам токен или ключ доступа.
1. Нажмите **Сохранить**.

**Важно:**
- Ключ существующих учетных данных нельзя изменить. Для изменения ключа удалите старые учетные данные и создайте новые.
- Значение существующих учетных данных можно обновить, введя новое значение.
- Учетные данные шифруются при сохранении и никогда не передаются в веб-интерфейс после сохранения.

#### Использование учетных данных в заголовках

Вместо прямого указания токена в заголовках провайдера используйте синтаксис шаблонизации:

```sh
Authorization: Bearer {{ .credentials.api_key }}
```

где `api_key` — это название ключа, которое вы указали при добавлении учетных данных.

**Примеры:**

Вместо:

```sh
Authorization: Bearer sk-1234567890abcdef
```

Используйте:

```sh
Authorization: Bearer {{ .credentials.openai_api_key }}
```

**Преимущества использования шаблонизации:**
- Токены не хранятся в открытом виде в базе данных.
- Учетные данные можно обновить без изменения конфигурации провайдера.
- Один набор учетных данных можно использовать в нескольких провайдерах.

**Как это работает:**
1. Вы добавляете учетные данные через профиль пользователя.
2. В заголовках провайдера указываете шаблон `{{ .credentials.название_ключа }}`.
3. При выполнении запроса система автоматически заменяет шаблон на фактическое значение учетных данных.

### Создание провайдера OpenAI (ChatGPT)

Для настройки провайдера OpenAI выполните следующие шаги:

1. Откройте профиль пользователя и перейдите на вкладку **AI-провайдеры**.
1. Нажмите кнопку **Добавить**.
1. Заполните форму:
   - **Название**: `ChatGPT` (или любое другое удобное имя).
   - **Провайдер**: выберите `OpenAI`.
   - **Модель**: укажите название модели, например `gpt-4` или `gpt-3.5-turbo`.
   - **URL**: `https://api.openai.com/v1/chat/completions`.
   - **Метод**: `POST`.
   - **Заголовки**: добавьте заголовок авторизации, используя учетные данные:

     ```sh
     Authorization: Bearer {{ .credentials.openai_api_key }}
     ```

     где `openai_api_key` — название ключа учетных данных (см. раздел [Учетные данные для провайдеров](#учетные-данные-для-провайдеров)).

1. Нажмите **Сохранить**.

### Создание провайдера Ollama

Для настройки локального провайдера Ollama:

1. Убедитесь, что Ollama запущена на вашем сервере.
1. Создайте нового провайдера:
   - **Название**: `Ollama Local`.
   - **Провайдер**: выберите `Ollama`.
   - **Модель**: укажите название модели, например `llama2` или `mistral`.
   - **URL**: `http://localhost:11434/api/generate` (или адрес вашего сервера Ollama).
   - **Метод**: `POST`.

1. Нажмите **Сохранить**.

### Создание кастомного провайдера

Для настройки кастомного REST API провайдера:

1. Создайте нового провайдера и выберите тип **Custom**.
1. Заполните основные поля (URL, метод, заголовки авторизации).
1. Нажмите **Сохранить**.

#### Поле ответа (Response Field)

Поле **Поле ответа** определяет путь к элементу JSON-ответа API, в котором содержится текст ответа модели. Этот путь используется для извлечения ответа из JSON, возвращаемого API провайдера.

**Формат указания пути:**
- Используйте точечную нотацию для доступа к вложенным полям.
- Для массивов используйте индекс, начиная с 0.
- Поле необязательно — если не указано, система попытается найти ответ автоматически.

**Примеры:**

Для OpenAI-совместимых API:

```json
choices.0.message.content
```

Это означает: взять первый элемент массива `choices`, затем поле `message`, затем поле `content`.

Для других форматов возможны значения `response.text`, `content`, `answer`.

**Как определить правильный путь:**
1. Выполните тестовый запрос к вашему API.
1. Изучите структуру JSON ответа.
1. Найдите поле, содержащее текст ответа модели.
1. Укажите путь к этому полю в точечной нотации.

#### Шаблон тела запроса (Request Body Template)

Поле **Шаблон тела запроса** определяет структуру JSON-запроса, который будет отправляться к API провайдера. В шаблоне можно использовать переменные, которые будут автоматически заменены на актуальные значения.

**Доступные переменные:**
- `{{.prompt}}` — текст вопроса пользователя (будет автоматически экранирован для JSON).
- `{{.model}}` — название модели, указанное в настройках провайдера.

**Примеры шаблонов:**

Для OpenAI-совместимых API:

```json
{
  "model": "{{.model}}",
  "messages": [
    {
      "role": "user",
      "content": "{{.prompt}}"
    }
  ],
  "temperature": 0.7
}
```

Для API с другим форматом:

```json
{
  "messages": [
    {
      "content": "{{.prompt}}",
      "role": "user"
    }
  ],
  "model": "{{.model}}",
  "stream": false
}
```

Для API с минимальной структурой запроса:

```json
{
  "query": "{{.prompt}}",
  "model_name": "{{.model}}"
}
```

**Важно:**
- Шаблон должен быть валидным JSON.
- Переменные `{{.prompt}}` и `{{.model}}` будут автоматически заменены при отправке запроса.
- Значение `{{.prompt}}` автоматически экранируется для безопасной вставки в JSON.
- Вы можете добавить любые дополнительные поля, необходимые для вашего API (temperature, max_tokens, и т.д.).

**Пример полной настройки кастомного провайдера:**

1. **Название**: `My Custom API`.
1. **Провайдер**: `Custom`.
1. **Модель**: `my-model-v1`.
1. **URL**: `https://api.example.com/v1/chat`.
1. **Метод**: `POST`.
1. **Заголовки**:

   ```sh
   Authorization: Bearer {{ .credentials.api_key }}
   Content-Type: application/json
   ```

   где `api_key` — название ключа учетных данных (см. раздел [Учетные данные для провайдеров](#учетные-данные-для-провайдеров)).

1. **Поле ответа**: `choices.0.message.content`.
1. **Шаблон тела запроса**:

   ```json
   {
     "model": "{{.model}}",
     "messages": [
       {
         "role": "user",
         "content": "{{.prompt}}"
       }
     ],
     "temperature": 0.7,
     "max_tokens": 1000
   }
   ```

## Работа с AI-агентом

### Открытие чата

AI-агент доступен через боковую панель чата в правой части интерфейса. Для открытия чата нажмите на кнопку чата в правом нижнем углу экрана или используйте горячую клавишу `/` для быстрого доступа.

### Выбор провайдера

В верхней части чата находится селектор провайдеров. Выберите нужный провайдер из списка доступных. Если у вас настроен только один провайдер, он будет выбран автоматически.

### Доступные инструменты (MCP Tools)

AI-агент использует инструменты MCP (Model Context Protocol) для работы с платформой. Полный список доступных инструментов с их описанием, параметрами и примерами использования доступен в [документации MCP-сервера](../mcp-server/).

**Основные возможности:**
- Получение списка ресурсов и их сущностей
- Просмотр доступных действий для ресурсов и сущностей
- Информация об источниках данных
- Self-service возможности

### Просмотр доступных инструментов

В чате отображается список всех доступных инструментов с их описаниями и примерами использования. Вы можете:

- Раскрыть раздел **Доступные инструменты** для просмотра списка.
- Раскрыть каждый инструмент для просмотра его параметров и примеров.
- Кликнуть на пример, чтобы вставить его в поле ввода и сразу выполнить или отредактировать запрос.

### Формулирование вопросов

Вы можете задавать вопросы AI-агенту в свободной форме на естественном языке. Агент автоматически определит, какие инструменты использовать, и выполнит запрос.

**Типы вопросов:**

- **Анализ данных**: «Сколько сервисов в статусе разработки?», «Покажи все сервисы с ошибками»
- **Работа с каталогом**: «Найди все сервисы, где жизненный цикл равен production»
- **Фильтрация и подсчет**: «Сколько сущностей в русурсе Deckhouse Code»
- **Комплексные запросы**: «Покажи все ресурсы и для каждого покажи количество сущностей»

### Форматы вывода

Вы можете указать, в каком формате хотите получить данные:

- **Таблица** (по умолчанию) — данные выводятся в виде таблицы
- **Список** — данные выводятся в виде списка

**Примеры:**
- "Покажи ресурсы списком"
- "Выведи действия таблицей"
- "Покажи ресурсы с полями name и slug"

### Мультизапросы

AI-агент может автоматически вызывать несколько инструментов последовательно для выполнения сложных запросов. Это происходит автоматически, когда для ответа на вопрос требуется информация из нескольких источников.

**Примеры мультизапросов:**

- "Покажи все ресурсы и для каждого покажи количество сущностей"
  - Агент сначала получит список ресурсов, затем для каждого ресурса получит сущности и подсчитает их количество

- **Вопросы о платформе**: «Как создать новое действие?», «Как настроить автоматизацию?».
- **Анализ данных**: «Сколько сервисов в статусе разработки?», «Покажи все сервисы с ошибками».
- **Работа с каталогом**: «Найди все сервисы, где жизненный цикл равен production».

AI-агент автоматически определит, какой инструмент использовать, и выполнит запрос.

### Особенности работы

1. **Анализ данных**: AI-агент не просто возвращает сырые данные, а анализирует их и предоставляет структурированные ответы.

2. **Фильтрация**: Вы можете запрашивать данные с условиями, и агент выполнит фильтрацию. Например: "Найди все сервисы, у которых параметр 'Жизненный цикл' равен 'разработка'".

3. **Агрегация**: Агент может подсчитывать количество, группировать данные и предоставлять статистику. Например: "Сколько сервисов в продакшене?" или "Посчитай количество сервисов в разработке".

4. **Контекст документации**: При вопросах о платформе агент использует официальную документацию.

5. **Творческие запросы**: Вы можете попросить агента создать творческий контент на основе данных. Например: "Опиши красиво все сервисы".

### Обработка результатов

После получения данных от инструментов система автоматически обрабатывает результаты:

- **Простые запросы** ("покажи", "выведи") — данные отображаются в виде форматированных таблиц или списков
- **Аналитические запросы** (фильтрация, подсчет, сравнение) — данные анализируются, и возвращается только нужный результат

> **Важно:** AI-агент никогда не показывает весь массив данных пользователю. Вместо этого он анализирует данные и возвращает только нужную информацию (например, количество найденных элементов или отфильтрованный список).

### Отладка

Если ответ агента кажется некорректным, вы можете просмотреть логи отладки, нажав на кнопку с иконкой вопроса рядом с ответом. Это поможет понять, какие инструменты были вызваны и какие данные были получены.

## Примеры использования

### Базовые запросы

**Получение списка ресурсов:**

```text
"Покажи все ресурсы"
"Выведи ресурсы таблицей"
"Покажи ресурсы списком"
```

**Получение сущностей ресурса:**

```text
"Получи все сервисы"
"Покажи все сущности ресурса 'Сервисы'"
"Найди все репозитории"
```

**Получение действий:**

```text
"Какие действия можно выполнить для сервисов?"
"Покажи действия для сервисов списком"
"Что можно сделать с сервисом 'my-service'?"
```

**Получение источников данных:**

```text
"Какие источники данных синхронизируют данные в ресурс 'Сервисы'?"
"Покажи источники данных для сервисов"
```

**Self-service возможности:**

```text
"Что я могу сделать для сервисов?"
"Какие self-service возможности есть?"
"Покажи все возможности для объекта 'backend-service'"
```

### Запросы с фильтрацией

**Фильтрация по параметрам:**

```text
"Найди все сервисы, у которых параметр 'Жизненный цикл' равен 'разработка'"
```

**Подсчет и статистика:**

```text
"Сколько всего сервисов?"
"Посчитай количество сервисов в разработке"
"Сколько действий доступно для сервисов?"
```

### Комплексные запросы (мультизапросы)

**Комбинирование данных:**

```text
"Покажи все ресурсы и для каждого покажи количество сущностей"
"Что можно сделать для сервисов и какие источники данных их синхронизируют?"
"Получи информацию о сервисе 'my-service': его действия и возможности"
```

### Пример 1: Анализ сервисов

**Вопрос:**

```sh
Получи все сервисы, найди те, у которых параметр 'Жизненный цикл' равен 'разработка', и выведи их количество
```

**Как это работает:**
1. AI-агент вызывает инструмент для получения всех сервисов
2. Получает массив всех сервисов
3. Фильтрует сервисы, где параметр "Жизненный цикл" равен "разработка"
4. Подсчитывает количество найденных сервисов
5. Возвращает результат: "Найдено 15 сервисов в разработке" (без показа всех данных)

**Результат:**
Агент использует инструменты MCP для получения данных о сервисах, проанализирует их и вернет количество сервисов в разработке.

### Пример 2: Комплексный анализ

**Вопрос:**

```sh
Покажи все сервисы с ошибками и основные причины ошибок
```

**Как это работает:**
1. AI-агент получает все сервисы
2. Анализирует статус здоровья каждого сервиса
3. Находит сервисы с ошибками
4. Извлекает информацию о причинах ошибок
5. Формирует структурированный список

**Результат:**
Агент получит данные о сервисах, проанализирует их статусы, найдет ошибки и предоставит структурированный список с причинами.

### Пример 3: Мультизапрос

**Вопрос:**

```sh
Покажи все ресурсы и для каждого покажи количество сущностей
```

**Как это работает:**
1. AI-агент вызывает инструмент для получения списка ресурсов
2. Для каждого ресурса вызывает инструмент для получения сущностей
3. Подсчитывает количество сущностей для каждого ресурса
4. Формирует итоговую таблицу или список

**Результат:**
Агент вернет список всех ресурсов с указанием количества сущностей в каждом, например: "Найдено 5 ресурсов: Сервисы (15 сущностей), Окружения (8 сущностей)..."

## Рекомендации

### ✅ Рекомендуется

1. **Используйте конкретные вопросы**: Чем конкретнее вопрос, тем точнее будет ответ. Вместо "что ты умеешь?" лучше спросить "что можно сделать для сервисов?"

2. **Указывайте параметры явно**: Если вы знаете название ресурса или параметр, укажите его в вопросе. Например: "Найди все сервисы, где 'Жизненный цикл' равен 'разработка'"

3. **Указывайте формат вывода**: Если нужен список, скажите "списком", если таблица — "таблицей"

4. **Задавайте комплексные вопросы**: Система сама определит, какие инструменты использовать. Не нужно указывать технические детали

5. **Экспериментируйте**: AI-агент понимает естественный язык, пробуйте разные формулировки вопросов

### ❌ Не рекомендуется

1. **Слишком общие вопросы**: "Что ты умеешь?" лучше заменить на "Что можно сделать для сервисов?"

2. **Технические детали**: Не нужно указывать точные имена инструментов, просто опишите задачу

3. **Множественные уточнения**: Задавайте один вопрос за раз
