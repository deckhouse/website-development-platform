---
title: Мониторинг здоровья внешних сервисов
menuTitle: Мониторинг внешних сервисов
d8Edition: ee
moduleStatus: experimental
---

Полное описание возможностей и инструкция по использованию проверок здоровья (health checks) для внешних сервисов.

## 1. Обзор

Мониторинг здоровья внешних сервисов позволяет:

- **Периодически проверять доступность** внешнего сервиса по HTTP(S).
- **Хранить статус** (healthy / unhealthy / unknown) и **историю проверок** (время, код ответа, время ответа, ошибки).
- **Уведомлять** при смене статуса (webhook или системный алерт).
- **Настраивать расписание** проверок по cron-выражениям (например, каждые 5 минут).

Проверки выполняются бэкендом в фоне. Для каждого внешнего сервиса с включённым мониторингом создаётся отдельное расписание; при изменении или удалении сервиса расписание обновляется автоматически.

---

## 2. Возможности

### 2.1. Включение и отключение мониторинга

- **Enable Monitoring** — общий переключатель мониторинга для сервиса.
- **Enable Health Check** — включение/выключение самих проверок в рамках мониторинга (при включённом мониторинге можно временно отключить только проверки).

При выключении мониторинга расписание для этого сервиса снимается, новые проверки не выполняются. Статус и история остаются в БД до удаления сервиса.

### 2.2. Настройки проверки (Health Check Settings)

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| **Schedule (cron)** | Частота проверок в формате cron (минута час день месяц день_недели). | `*/5 * * * *` (каждые 5 минут) |
| **Timeout** | Таймаут одного HTTP-запроса (например, `10s`, `30s`). | `10s` |
| **Method** | HTTP-метод запроса. | GET |
| **Path** | Путь относительно базового URL сервиса (например, `/health`, `/api/status`). | `/health` |
| **Expected Status Code** | Ожидаемый HTTP-код ответа для признания проверки успешной. | 200 |
| **Request Body** | Тело запроса в YAML/JSON (для POST/PUT/PATCH). | — |
| **Headers** | Дополнительные заголовки запроса. | — |

Итоговый URL проверки: `{URL сервиса}{Path}` (например, `https://api.example.com/health`).

**Статусы:**

- **healthy** — запрос выполнен, код ответа совпадает с ожидаемым.
- **unhealthy** — ошибка сети, таймаут, код ответа не совпадает или сервер вернул 5xx/429.
- **unknown** — проверка ещё не выполнялась или данные отсутствуют.

### 2.3. Уведомления (Notifications)

При смене статуса можно отправить уведомление:

| Тип | Описание |
|-----|----------|
| **None** | Уведомления отключены. |
| **Webhook** | HTTP-запрос на указанный URL при переходе в unhealthy или при восстановлении (healthy). Настраиваются URL, метод, заголовки; в теле можно использовать шаблоны. |
| **System Alert** | Создание системного алерта в системе (если эта функция включена). Задаются шаблоны имени и описания алерта. |

**Шаблоны сообщений** (для webhook и алертов):

- `{{.service.name}}` — имя внешнего сервиса.
- `{{.service.url}}` — URL сервиса.
- `{{.status}}` — новый статус (healthy / unhealthy).
- `{{.error}}` — текст ошибки (если есть).
- `{{.responseTime}}` — время ответа в миллисекундах.

Пример текста при падении:  
`Service {{.service.name}} is unhealthy. Error: {{.error}}`

### 2.4. История проверок

- Для **каждого** внешнего сервиса хранится своя история проверок.
- По умолчанию хранится **не более 10 последних записей** на сервис; старые удаляются автоматически после каждой новой проверки.
- В каждой записи: время проверки, статус, время ответа (мс), текст ошибки (если есть).

Лимит 10 записей на сервис задаётся в коде и не настраивается через конфиг.

---

## 3. Инструкция: как пользоваться

### 3.1. Через веб-интерфейс

1. **Перейдите в раздел внешних сервисов**  
   Администрирование → Внешние сервисы (External Services).

2. **Создайте или откройте внешний сервис**  
   - Создать: кнопка «Подключить» / «Connect», заполните имя, slug, URL и при необходимости системную учётную запись, заголовки.  
   - Редактировать: кнопка с иконкой карандаша у нужной строки.

3. **Вкладка «Мониторинг»**  
   - Включите **«Enable Monitoring»**.  
   - Включите **«Enable Health Check»**.  
   - Задайте **Schedule (cron)** — например, `*/5 * * * *` для проверки каждые 5 минут.  
   - При необходимости измените **Timeout**, **Method**, **Path**, **Expected Status Code**, тело запроса и заголовки.  
   - В блоке **«Notifications»** выберите тип уведомления (None / Webhook / System Alert) и при необходимости настройте webhook (URL, метод, заголовки) или шаблоны алерта.  
   - Сохраните сервис.

4. **Просмотр статуса и истории**  
   - В таблице внешних сервисов колонка **«Status»** показывает текущий статус (healthy / unhealthy / unknown).  
   - Для редактирования откройте сервис и на вкладке «Мониторинг» внизу отображаются:  
     - **Health Status** — последняя проверка, время ответа, последняя ошибка.  
     - **Check History** — таблица последних проверок (время, статус, время ответа, ошибка).

5. **Только настройка мониторинга без полного редактирования**  
   На странице списка внешних сервисов у строки есть кнопка с иконкой монитора («Configure monitoring») — открывается тот же диалог редактирования с фокусом на вкладке «Мониторинг».

### 3.2. Через API

Базовый путь: `GET/POST/PUT/DELETE /api/v2/external_services` и по UUID: `/api/v2/external_services/:external_service_uuid`.

**Создание/обновление сервиса с мониторингом (фрагмент тела запроса):**

```json
{
  "name": "My API",
  "slug": "my-api",
  "url": "https://api.example.com",
  "monitoringEnabled": true,
  "monitoringConfig": {
    "enabled": true,
    "scheduleExpression": "*/5 * * * *",
    "method": "GET",
    "path": "/health",
    "expectedStatusCode": 200,
    "timeout": "10s",
    "notificationType": "none",
    "messages": {
      "unhealthyMessage": "Service {{.service.name}} is unhealthy",
      "recoveryMessage": "Service {{.service.name}} recovered"
    },
    "webhookMethod": "POST"
  }
}
```

**Получение текущего статуса здоровья:**

```http
GET /api/v2/external_services/:external_service_uuid/health
```

Ответ содержит `status`, `lastCheckAt`, `lastSuccessAt`, `lastError`, `responseTimeMs` и т.п.

**Получение истории проверок:**

```http
GET /api/v2/external_services/:external_service_uuid/health/history?limit=10&offset=0
```

В ответе — массив записей с полями `checkedAt`, `status`, `responseTimeMs`, `error`.

---

## 4. Cron-выражения (расписание)

Формат: **минута час день_месяца месяц день_недели** (стандартный cron с поддержкой шагов и диапазонов).

Примеры:

| Выражение | Значение |
|-----------|----------|
| `*/5 * * * *` | Каждые 5 минут |
| `*/1 * * * *` | Каждую минуту |
| `0 * * * *` | Каждый час (в ноль минут) |
| `0 */2 * * *` | Каждые 2 часа |
| `0 0 * * *` | Раз в день в полночь |
| `0 9 * * 1-5` | В 9:00 по будням |

Неверное выражение при сохранении сервиса приведёт к ошибке валидации (и на бэкенде, и в UI при наличии проверки).

---

## 5. Ограничения и замечания

- **Таймаут** — это максимальное время ожидания одного HTTP-запроса проверки, а **расписание (cron)** — как часто такая проверка запускается. Они независимы.
- Одна проверка по одному сервису выполняется не чаще одного раза в момент срабатывания cron; параллельные проверки одного и того же сервиса блокируются.
- История: **не более 10 записей на сервис**; лимит общий для всех сервисов (10 на каждый), настраивается только в коде.
- Уведомления отправляются **только при смене статуса** (например, healthy → unhealthy или unhealthy → healthy), а не при каждой проверке.
- Для webhook можно указать свой URL, метод и заголовки; в теле используются те же шаблоны, что и в сообщениях.

---

## 6. Где что настраивается

| Что | Где |
|-----|-----|
| Включение мониторинга, расписание, метод, путь, код ответа, таймаут, тело, заголовки | UI: форма внешнего сервиса → вкладка «Мониторинг» / API: `monitoringConfig` в теле создания/обновления |
| Тип уведомлений и параметры webhook/алерта | Тот же блок «Notifications» в форме / те же поля в `monitoringConfig` |
| Просмотр текущего статуса | UI: вкладка «Мониторинг» в карточке сервиса; API: `GET .../health` |
| Просмотр истории проверок | UI: таблица «Check History» на вкладке «Мониторинг»; API: `GET .../health/history` |
| Лимит записей истории (10 на сервис) | Только в коде бэкенда (константа и конфиг при старте) |

---

## 7. Краткий чек-лист

1. Создать или открыть внешний сервис (URL, при необходимости системная учётная запись).  
2. Включить **Enable Monitoring** и **Enable Health Check**.  
3. Задать **Schedule (cron)** (например, `*/5 * * * *`).  
4. При необходимости изменить Path, Method, Expected Status Code, Timeout.  
5. При необходимости включить уведомления (Webhook или System Alert) и настроить их.  
6. Сохранить.  
7. Следить за статусом в таблице и в карточке сервиса, при необходимости смотреть историю и логи бэкенда.

Если после сохранения статус остаётся **unknown**, дождитесь первого срабатывания расписания (например, в течение 5 минут при `*/5 * * * *`) или проверьте логи бэкенда на ошибки выполнения проверки.
