---
title: Мониторинг внешних сервисов
menuTitle: Мониторинг внешних сервисов
d8Edition: ee
moduleStatus: experimental
---

Мониторинг внешних сервисов — это механизм автоматической проверки доступности и корректности работы внешних сервисов, подключенных к платформе. Платформа выполняет периодические health-check’и и отображает актуальный статус каждого сервиса в интерфейсе.

## Как это работает

Платформа автоматически выполняет проверки здоровья внешних сервисов по расписанию. Для каждого сервиса можно настроить параметры проверки: метод запроса, путь, ожидаемый HTTP-статус, таймаут, заголовки и (при необходимости) тело запроса.

Результат каждой проверки сохраняется, а статус сервиса обновляется на основании последнего успешного или неуспешного ответа.

Возможные статусы:

- `healthy` — сервис доступен и ответ соответствует ожидаемым параметрам.
- `unhealthy` — сервис недоступен, не отвечает в пределах таймаута или возвращает неожидаемый статус/ошибку.
- `unknown` — статус пока не определён (например, проверка ещё не выполнялась или данные о последней проверке отсутствуют).

## Настройка мониторинга

Настройка мониторинга выполняется в разделе «Администрирование» → «Внешние сервисы» при создании или редактировании внешнего сервиса.

### Параметры мониторинга

| Параметр | Описание | Пример |
|----------|----------|--------|
| **Включить мониторинг** | Включает или выключает автоматические проверки здоровья сервиса | Включено |
| **Интервал проверки** | Как часто выполнять проверку здоровья сервиса | `5m`, `1h`, `30s` |
| **Метод запроса** | HTTP метод для проверки здоровья | `GET`, `POST`, `PUT` |
| **Путь для проверки** | Путь на сервере для проверки здоровья | `/health`, `/api/status` |
| **Ожидаемый статус код** | HTTP статус код, который считается успешным | `200`, `201` |
| **Таймаут запроса** | Максимальное время ожидания ответа | `10s`, `30s` |
| **Заголовки** | Дополнительные HTTP заголовки для запроса | `Content-Type: application/json` |
| **Тело запроса** | Тело запроса (для POST/PUT методов) | JSON или YAML формат |

### Примеры настройки

Проверка через GET запрос:

- Метод: `GET`;
- Путь: `/health`;
- Ожидаемый статус код: `200`;
- Таймаут: `10s`.

Проверка через POST запрос:

- Метод: `POST`;
- Путь: `/api/health/check`;
- Ожидаемый статус код: `200`;
- Тело запроса: `{"check": true}`;
- Заголовки: `Content-Type: application/json`.

### Использование шаблонов

В заголовках и теле запроса можно использовать шаблоны для подстановки значений:

- `{{.service.name}}` — название сервиса;
- `{{.service.url}}` — URL сервиса;
- `{{.status}}` — текущий статус;
- `{{.error}}` — текст ошибки;
- `{{.responseTime}}` — время ответа.

## Просмотр статуса здоровья

Статус здоровья внешнего сервиса отображается в нескольких местах:

- в списке внешних сервисов;
- в карточке сервиса;
- в истории проверок;
- в виджете на дашборде (если он включён).

**В списке внешних сервисов** — в разделе «Администрирование» → «Внешние сервисы» в таблице сервисов отображается колонка «Статус» с цветовой индикацией:

- зеленый — сервис работает (`healthy`);
- красный — сервис недоступен (`unhealthy`);
- серый — статус не определен (`unknown`).

**В карточке сервиса** — при открытии карточки внешнего сервиса отображается подробная информация о статусе здоровья:

- текущий статус;
- время последней проверки;
- время последней успешной проверки;
- время ответа (response time);
- текст последней ошибки (при наличии).

**В истории проверок** — в карточке сервиса доступна история последних проверок здоровья. История содержит:

- статус каждой проверки;
- время проверки;
- время ответа;
- текст ошибки (если проверка завершилась неуспешно).

По умолчанию сохраняются последние 10 записей истории. Количество записей можно настроить в конфигурации платформы.

**В виджете на дашборде** — виджет «Здоровье внешних сервисов»  позволяет отслеживать состояние всех внешних сервисов с включенным мониторингом на дашборде.

Виджет отображает:

- Сводную статистику — общее количество сервисов, число сервисов в статусах `healthy`, `unhealthy` и `unknown`.
- Таблицу сервисов — список всех сервисов с информацией о каждом:
  - Название сервиса;
  - Статус здоровья;
  - Время ответа;
  - Время последней проверки;
  - Описание ошибки (при наличии).

Виджет поддерживает пагинацию для удобного просмотра большого количества сервисов. Можно выбрать количество записей на странице: 5, 10, 20, 50 или 100.

## Уведомления

При изменении статуса здоровья внешнего сервиса платформа может отправлять уведомления. Настройки уведомлений задаются в конфигурации мониторинга конкретного сервиса.

Типы уведомлений:

- **Без уведомлений** — уведомления не отправляются.
- **Webhook** — отправка уведомления на указанный вебхук URL.
- **Системное уведомление** — создание системного уведомления в платформе (доступно только администраторам).

Уведомления отправляются при следующих событиях:

- `healthy` → `unhealthy` — сервис стал недоступен или начал отвечать с ошибкой.
- `unhealthy` → `healthy` — сервис восстановился и снова проходит проверку.

В тексте уведомления можно использовать переменные-шаблоны:

- `{{service.name}}` — название сервиса;
- `{{service.url}}` — URL сервиса;
- `{{status}}` — текущий статус;
- `{{error}}` — текст ошибки;
- `{{responseTime}}` — время ответа.

Пример сообщения:

```text
Сервис {{.service.name}} ({{.service.url}}) стал недоступен.
Ошибка: {{.error}}
Время ответа: {{.responseTime}}ms
```

## Проверка доступности перед использованием

Платформа может проверять доступность внешнего сервиса перед тем, как использовать его в операциях, которые зависят от этого сервиса:

- **Источники данных** — перед синхронизацией данных;
- **Действия** — перед выполнением действия, использующего внешний сервис;
- **Виджеты** — перед загрузкой данных в виджет;
- **Действия виджетов** — перед запуском действия из интерфейса виджета.

Если сервис недоступен (статус `unhealthy`), операция будет заблокирована, а пользователь увидит понятное сообщение об ошибке. Это снижает риск «тихих» сбоев и предотвращает выполнение операций, которые заведомо не смогут завершиться успешно.

> **Важно:** если мониторинг для сервиса выключен, проверка доступности перед использованием не выполняется, и операции могут запускаться независимо от фактического состояния сервиса.

## Рекомендации

### Настройка интервала проверки

Подбирайте интервал исходя из критичности сервиса и допустимого времени реакции на инцидент:

- **Критичные сервисы** — проверка каждые 1-5 минут;
- **Важные сервисы** — проверка каждые 15-30 минут;
- **Обычные сервисы** — проверка каждый час или реже.

### Настройка таймаута

Таймаут должен учитывать нормальное время ответа сервиса и сетевые задержки:

- Для быстрых сервисов — 5-10 секунд;
- Для медленных сервисов — 30-60 секунд.

### Использование health-check эндпоинтов

Рекомендуется использовать отдельные эндпоинты для проверки здоровья (например, `/health`, `/api/status`). Такие эндпоинты должны:

- отвечать быстро;
- по возможности не требовать авторизации или использовать минимальные права;
- не создавать заметной нагрузки на сервис.

### Мониторинг критичных сервисов

Для сервисов, от которых зависит работа ключевых процессов, рекомендуется:

- включить уведомления о смене статуса;
- установить короткий интервал проверки;
- использовать системные уведомления для администраторов (или вебхук-интеграцию с вашим on-call каналом).
