---
title: MCP-сервер
---

{{< alert level="warning" >}}
Экспериментальный функционал
{{< /alert >}}

MCP-сервер — это компонент Deckhouse Development Platform, который реализует протокол MCP (Model Context Protocol) и обеспечивает взаимодействие внешних AI-клиентов (таких как LM Studio, Claude Desktop и других) с данными платформы.
Сервер работает по JSON-RPC 2.0 и предоставляет набор инструментов (tools) для работы с ресурсами платформы и получения информации из документации.

MCP — это открытый протокол для взаимодействия AI-моделей с внешними системами. Подробнее о протоколе можно узнать на [официальном сайте MCP](https://modelcontextprotocol.io/).

## Доступные инструменты

### get_resources

Получение списка всех ресурсов в платформе.

**Параметры:**

| Название | Тип | Описание | Примеры |
|----------|-----|----------|---------|
| Нет параметров | - | Инструмент не требует параметров | - |

**Описание:**
Инструмент возвращает список всех доступных ресурсов в платформе. Ресурс — это тип объекта (например, "Сервисы", "Окружения", "Команды").

**Пример использования:**

```sh
Покажи все ресурсы
```

```sh
Выведи ресурсы таблицей
```

```sh
Покажи ресурсы списком
```

**Возвращаемые данные:**
- Массив ресурсов с информацией о каждом ресурсе (название, slug, описание).

### get_resource_entities

Получение всех сущностей указанного ресурса со всеми их свойствами и данными для анализа и агрегации.

**Параметры:**

| Название                | Тип    | Описание                  | Примеры                                           |
|-------------------------|--------|---------------------------|---------------------------------------------------|
| `resource_name_or_slug` | строка | Название или slug ресурса | `Сервисы`, `services`, `Deckhouse Code: Repositories` |

**Описание:**
Инструмент возвращает полный список сущностей указанного ресурса с их свойствами, метаданными, связями и другой информацией. Данные можно использовать для анализа, фильтрации, агрегации и построения отчетов.

**Пример использования:**

```sh
Получи все сервисы, найди те, у которых параметр 'Жизненный цикл' равен 'разработка', и выведи их в таблицу формата 'название сервиса | жизненный цикл | дата создания'
```

**Возвращаемые данные:**
- Массив сущностей с полной информацией о каждой сущности.
- Свойства сущностей (properties).
- Метаданные (создание, обновление, владелец).
- Связи с другими сущностями (родители, дочерние элементы).
- Статус сущностей (health status).

> **Важно:** Этот инструмент возвращает все сущности ресурса. AI-агент автоматически анализирует данные и возвращает только нужный результат (например, количество найденных элементов или отфильтрованный список), а не весь массив данных.

### get_actions_for_resource

Получение списка всех действий, которые можно выполнить для объектов конкретного ресурса.

**Параметры:**

| Название                | Тип    | Описание                  | Примеры                                           |
|-------------------------|--------|---------------------------|---------------------------------------------------|
| `resource_name_or_slug` | строка | Название или slug ресурса | `Сервисы`, `services`, `Deckhouse Code: Repositories` |

**Описание:**
Инструмент возвращает список всех действий, доступных для выполнения с объектами указанного ресурса.

**Пример использования:**

```sh
Какие действия можно выполнить для сервисов?
```

```sh
Покажи действия для сервисов списком
```

```sh
Выведи действия для ресурса 'Сервисы' таблицей
```

**Возвращаемые данные:**
- Массив действий с информацией о каждом действии (название, описание, параметры).

### get_actions_for_entity

Получение всех действий, которые можно выполнить для конкретной сущности.

**Параметры:**

| Название                | Тип    | Описание                  | Примеры                                           |
|-------------------------|--------|---------------------------|---------------------------------------------------|
| `resource_name_or_slug` | строка | Название или slug ресурса | `Сервисы`, `services`, `Deckhouse Code: Repositories` |
| `entity_name_or_slug`   | строка | Название или slug сущности | `my-service`, `backend-service` |

**Описание:**
Инструмент возвращает все действия, которые можно выполнить для конкретной сущности. Включает проверку ограничений по статусу здоровья объекта.

**Пример использования:**

```sh
Какие действия доступны для сервиса 'my-service'?
```

```sh
Что можно сделать с сервисом 'backend-service'?
```

```sh
Покажи действия для объекта 'my-app' в ресурсе 'Приложения'
```

**Возвращаемые данные:**
- Массив действий с информацией о каждом действии (название, описание, параметры, доступность).

### get_datasources_for_resource

Получение списка всех источников данных, которые синхронизируют данные в конкретный ресурс.

**Параметры:**

| Название                | Тип    | Описание                  | Примеры                                           |
|-------------------------|--------|---------------------------|---------------------------------------------------|
| `resource_name_or_slug` | строка | Название или slug ресурса | `Сервисы`, `services`, `Deckhouse Code: Repositories` |

**Описание:**
Инструмент возвращает список всех источников данных, которые синхронизируют данные в указанный ресурс.

**Пример использования:**

```sh
Какие источники данных синхронизируют данные в ресурс 'Сервисы'?
```

```sh
Покажи источники данных для сервисов
```

```sh
Какие внешние системы синхронизируют данные в 'Сервисы'?
```

**Возвращаемые данные:**
- Массив источников данных с информацией о каждом источнике (название, тип, описание).

### get_self_service_capabilities

Получение полной информации о self-service возможностях для ресурса или сущности.

**Параметры:**

| Название                | Тип    | Описание                  | Примеры                                           |
|-------------------------|--------|---------------------------|---------------------------------------------------|
| `resource_name_or_slug` | строка | Название или slug ресурса | `Сервисы`, `services`, `Deckhouse Code: Repositories` |
| `entity_name_or_slug`   | строка | (опционально) Название или slug сущности | `my-service`, `backend-service` |

**Описание:**
Инструмент возвращает полную информацию о self-service возможностях для ресурса или сущности. Возвращает список доступных действий и источников данных для синхронизации.

**Пример использования:**

```sh
Что я могу сделать для сервисов?
```

```sh
Какие self-service возможности есть для сервисов?
```

```sh
Что можно сделать с сервисом 'my-service'?
```

```sh
Покажи все возможности для объекта 'backend-service'
```

**Возвращаемые данные:**
- Список доступных действий для ресурса или сущности.
- Список источников данных для синхронизации.

### get_external_data

Выполнение HTTP запроса к внешнему сервису с использованием учетных данных пользователя.

**Параметры:**

| Название                | Тип    | Описание                                                                                                          | Примеры                                                                                      |
|-------------------------|--------|-------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|
| `external_service_name` | строка | Название внешнего сервиса. Будет выполнен поиск по имени или slug сервиса                                         | `sonarqube`, `gitlab`, `kubernetes`                                                          |
| `query`                 | строка | Описание запроса                                                                                                  | `get pipelines for project 123`, `get sonarqube projects`, `get all namespaces`              |
| `api_path`              | строка | Путь к API endpoint с параметрами запроса. Генерируется моделью на основе `query` и `external_service_name`       | `/api/v4/projects?per_page=100&page=1`                                                       |
| `method`                | строка | HTTP-метод. По умолчанию: GET. Модель определяет правильный метод на основе `query`                               | `GET`, `POST`, `PUT`, `DELETE`, `PATCH`                                                      |
| `body`                  | строка | Тело запроса для POST/PUT/PATCH методов (JSON строка). Модель формирует правильное тело запроса на основе `query` | `{"title":"New MR","source_branch":"feature"}`                                                |

**Описание:**
Инструмент позволяет выполнять HTTP запросы к внешним сервисам, настроенным в платформе. Сервис находится по имени, затем автоматически получаются необходимые учетные данные пользователя (credentials), и выполняется HTTP запрос к указанному API endpoint.

Модель должна самостоятельно определить правильный API endpoint, HTTP метод и тело запроса на основе описания запроса (`query`) и названия сервиса (`external_service_name`), используя свои знания об API различных сервисов.

**Важно:**
- Для запросов типа «получить все» (get all) модель должна добавить параметры пагинации в `api_path` с максимальными значениями для сервиса.
  - GitLab: `/api/v4/projects?per_page=100&page=1`.
  - Kubernetes: `/api/v1/namespaces?limit=500`.
  - SonarQube: `/api/projects/search?p=1&ps=100`.
- Учетные данные пользователя подставляются автоматически из настроек внешнего сервиса.
- Заголовки из настроек внешнего сервиса применяются к запросу.

**Примеры использования:**

```sh
Получи все namespaces из внешнего сервиса Kubernetes
```

```sh
Получи список проектов из SonarQube
```

```sh
Получи все pipelines для GitLab проекта с ID 123
```

```sh
Создай merge request в GitLab для проекта 456 с веткой feature/new-feature
```

**Возвращаемые данные:**
- `externalServiceName` — название внешнего сервиса.
- `url` — полный URL запроса.
- `method` — использованный HTTP метод.
- `statusCode` — HTTP статус код ответа.
- `headers` — заголовки ответа.
- `body` — тело ответа (парсится как JSON, если возможно).

**Пример ответа:**

```json
{
  "externalServiceName": "Kubernetes",
  "url": "https://k8s.example.com/api/v1/namespaces?limit=500",
  "method": "GET",
  "statusCode": 200,
  "headers": {
    "Content-Type": "application/json"
  },
  "body": {
    "items": [
      {
        "metadata": {
          "name": "default",
          "uid": "..."
        }
      }
    ]
  }
}
```

## Подключение MCP-сервера

### LM Studio

1. **Получение параметров**

   - Войдите в Deckhouse Development Platform.
   - Получите ваш API токен в разделе настроек профиля.
   - Запишите URL вашей платформы (например: `https://ddp.example.com`).

1. **Настройка в LM Studio**

   - Откройте LM Studio.
   - Перейдите в настройки (Settings).
   - Найдите раздел **MCP Servers** или **Model Context Protocol**.
   - Нажмите **Add Server** или **Добавить сервер**.

1. **Конфигурация сервера**

   Заполните следующие параметры:

   - **Server Name**: `DDP MCP Server` (или любое удобное имя).
   - **Server URL**: `https://ddp.example.com/api/v2/mcp`.
     - Замените `ddp.example.com` на адрес вашей платформы.
   - **Transport**: `HTTP` или `JSON-RPC`.
   - **Authentication**:
     - **Type**: `Custom Header` или `API Key`.
     - **Header Name**: `X-API-TOKEN`.
     - **Token**: вставьте ваш API токен от платформы.

1. **Проверка подключения**

   - Сохраните конфигурацию.
   - LM Studio попытается подключиться к серверу.
   - Если подключение успешно, вы увидите список доступных инструментов:
      - `get_resources`
      - `get_resource_entities`
      - `get_actions_for_resource`
      - `get_actions_for_entity`
      - `get_datasources_for_resource`
      - `get_self_service_capabilities`
      - `get_external_data`

После успешного подключения вы можете использовать инструменты в диалогах с моделями:

- `get_resources` для получения списка всех ресурсов.
- `get_resource_entities` для получения данных о сущностях ресурса.
- `get_actions_for_resource` для получения действий, доступных для ресурса.
- `get_actions_for_entity` для получения действий, доступных для конкретной сущности.
- `get_datasources_for_resource` для получения источников данных ресурса.
- `get_self_service_capabilities` для получения полной информации о self-service возможностях.
- `get_external_data` для выполнения запросов к внешним сервисам (GitLab, SonarQube, Kubernetes и др.).

Все вызовы будут выполняться с вашими правами доступа.

### Подключение в других MCP-клиентах

MCP-сервер Deckhouse Development Platform совместим с любыми клиентами, поддерживающими протокол MCP через JSON-RPC 2.0.

Общие шаги подключения:

1. **URL эндпоинта**: `https://your-platform.com/api/v2/mcp`.
1. **Протокол**: JSON-RPC 2.0.
1. **Аутентификация**:
   - Заголовок: `X-API-TOKEN: YOUR_API_TOKEN`.
   - Где `YOUR_API_TOKEN` — ваш API токен от платформы.
1. **Метод**: POST.

### Пример запроса к MCP-серверу

**HTTP-заголовки:**

```sh
X-API-TOKEN: your-api-token-here
Content-Type: application/json
```

**Тело запроса:**

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "get_resource_entities",
    "arguments": {
      "resource_name_or_slug": "Сервисы"
    }
  }
}
```

### Пример ответа от MCP-сервера

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "[{\"uuid\":\"...\",\"name\":\"Service 1\",\"properties\":{...}},...]"
      }
    ]
  }
}
```

## Безопасность

### Аутентификация

- Все запросы к MCP-серверу должны быть аутентифицированы с помощью API-токена из вашего профиля. Токен передается через заголовок `X-API-TOKEN: TOKEN`.
- Права доступа соответствуют правам вашего пользователя в платформе.

### Права доступа

- Инструменты работают с теми же правами, что и пользователь.
- Если у вас нет доступа к ресурсу, инструмент вернет ошибку доступа.
- Данные фильтруются в соответствии с вашими правами RBAC.

## Устранение неполадок

### Не удается подключиться к серверу

- Проверьте правильность URL (должен заканчиваться на `/api/v2/mcp`).
- Убедитесь, что API токен действителен.
- Проверьте, что платформа доступна с вашего компьютера.
- Проверьте настройки файрвола и прокси.

### Ошибка аутентификации

- Проверьте правильность формата токена.
- Убедитесь, что токен не истек.
- Убедитесь, что используется заголовок `X-API-TOKEN` (не `Authorization`).

### Инструмент возвращает ошибку доступа

- Убедитесь, что у вашего пользователя есть права на доступ к запрашиваемому ресурсу.
- Проверьте правильность имени или slug ресурса.
- Обратитесь к администратору платформы для проверки прав доступа.

### Данные не возвращаются

- Проверьте правильность параметров запроса.
- Убедитесь, что ресурс существует и содержит сущности.
- Проверьте логи платформы для получения детальной информации об ошибке.
