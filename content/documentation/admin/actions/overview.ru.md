---
title: Обзор
weight: 10
---

Действия — это механизм платформы, предназначенный для выполнения операций во внешних инфраструктурных системах и сервисах, находящихся за пределами платформы.
С помощью действий можно, например, создавать:

- проекты, переменные, ветки либо теги для проектов в Gitlab.
- ресурсы в Kubernetes.
- секреты в Deckhouse Stronghold, либо в HashiCorp Vault.
- проекты в SonarQube, DefectDojo, и других системах.
- топики и ACL в Kafka.

Каждое действие может быть привязано к одному или нескольким ресурсам и может быть запущено для любой сущности данных ресурсов.

## Конфигурация действия

### Основная информация

Для каждого действия, при его создании или изменении, указывается основная информация:

- **Название** (обязательно) — название действия в произвольном формате.
- **Идентификатор** (обязательно) — идентификатор действия. Генерируется автоматически из названия.
- **Ресурс** (опционально) — один или несколько ресурсов, для которых будет доступен запуск действия.
- **Иконка** (опционально) — иконка, которая будет отображаться в карточке действия.
- **Владелец** (опционально) — учетная запись пользователя, отвечающего за конфигурацию и работоспособность действия.
- **Команда владелец** (опционально) — команда, отвечающая за конфигурацию и работоспособность действия.
- **Теги** (опционально) — теги, которые могут помогать в понимании того, зачем и когда используется действие.
- **Описание** (опционально) — описание действия в Markdown, которое будет отображаться при запуске действия или сценария, содержащего действие.

### Пользовательская форма

#### Параметры

В разделе «Пользовательская форма» указываются параметры, которые будут доступны для заполнения при запуске действия. Типы параметров описаны в документации в разделе [«Параметры»](../../user/properties/).

Для каждого параметра доступен выбор следующих опций:

- **Редактируемый** — позволяет изменить значение параметра при запуске действия. Если опция отключена, значение параметра изменить нельзя.
- **Обязательный** — требует указания значения при запуске действия.
- **Скрытый** — параметр не отображается в пользовательской форме при запуске действия.

Для каждого параметра можно задать значение по умолчанию, которое будет подставляться в пользовательскую форму при запуске действия.

{{< alert level="info" >}}
Для нередактируемых или скрытых параметров рекомендуется всегда указывать значение по умолчанию, так как при запуске действия пользователь не может их изменить.
{{< /alert >}}

Описание каждого параметра будет отображаться при запуске действия при нажатии на кнопку со значком «info». Заполнение описаний рекомендуется, так как они упрощают понимание назначения параметров и снижают риск ошибок при запуске.

В качестве значений для пользовательской формы возможно использование шаблонных функций [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax). Например, выражение `{{ .entity.name }}`, заданное в качестве значения параметра, будет означать, что при запуске действия подставится название сущности, для которой запускается действие.

#### Условия параметров

Параметры могут быть скрыты или показаны в пользовательской форме в зависимости от значения параметра типа `Boolean`. Настройка скрытия или показа параметров осуществляется в разделе «Условия параметров».

### Бэкенд

#### Тип

Действие может выполняться с использованием одного из двух типов бэкенда:

- **Встроенный (BuiltIn)** — основная логика действия выполняется внутри платформы.

  > При выборе встроенного бэкенда необходимо указать конкретный тип встроенного действия. В зависимости от выбранного типа платформа автоматически формирует пример тела запроса и определяет перечень учетных данных, необходимых для выполнения действия.

- **Вебхук (Webhook)** — основная логика действия выполняется внешним сервисом, которому платформа отправляет HTTP-запрос.

#### Маскирование полей действия

Для каждого действия можно настроить маскировку полей, содержащих потенциально конфиденциальную информацию.

При установке флага **маскировать поля действия** в записях действия будут скрыты:

- Поле `body` (тело запроса).
- Поле `response` (ответ, который генерируется после выполнения действия).
- Значение всех заполненных параметров.

#### Временный ответ

Для каждого действия можно включить опцию **временный ответ**, которая позволяет скрыть ответ действия от других пользователей.

При включенной опции, после успешного выполнения действия ответ сохраняется как временный и показывается только инициатору действия. Обычный ответ очищается, чтобы скрыть его от других пользователей. Они будут видеть только зашифрованный временный ответ.

Инициатор действия может удалить временный ответ вручную.

{{< alert level="info" >}}
Временный ответ доступен только для инициатора действия. Остальные пользователи не могут просмотреть содержимое временного ответа и не имеют возможности его удалить.
{{< /alert >}}

#### Количество перезапусков

Если выполнение действия завершается с ошибкой, платформа может автоматически выполнить повторные попытки. Параметр **количество перезапусков** задает максимальное количество автоматических перезапусков действия.

#### Базовая задержка (сек.)

Параметр **базовая задержка** задает интервал между попытками перезапуска действия. Интервал увеличивается при каждом перезапуске, например, если базовая задержка задана в 2 секунды, то первая попытка перезапуска действия будет через 2 секунды, вторая попытка через 4 секунды, третья - через 8 секунд и так далее.

#### Тело запроса

Каждое действие отправляет HTTP-запрос на встроенный бэкенд, либо на URL вебхука бэкенда.
В большинстве случаев запрос должен содержать тело, в котором описывается спецификация данного запроса.

Для встроенного бэкенда при редактировании действия доступен пример тела запроса.

#### Пример тела запроса

В тело запроса действия могут быть подставлены параметры из пользовательской формы в формате [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax) с использованием синтаксиса YAML.

Пример:

```yaml
project_id: {{ .project_id }}
```

При подобном теле запроса конструкция `{{ .project_id }}` будет заменена на значение параметра **project_id**, которое, в свою очередь, будет браться из пользовательской формы.

#### Итоговое тело запроса

Поле **итоговое тело запроса** показывает, как будет выглядеть запрос после форматирования. При валидном JSON будет работать подсветка синтаксиса. При отсутствии подсветки обратите внимание на корректность формирования тела запроса.

#### URL

Для выполнения любого действия вебхука, в поле **URL** необходимо указать URL внешнего бэкенда, на который будет отправлен запрос.

Для встроенных действий в поле **URL** может указываться URL инфраструктурного сервиса, с которым будет происходить взаимодействие, либо данное поле может оставаться пустым. Подробности указаны в описании конкретных встроенных действий.

#### Выключить проверку SSL

Параметр определяет, будет ли проверяться SSL-сертификат бэкенда при выполнении вебхук-действия либо SSL-сертификат инфраструктурного сервиса, с которым происходит взаимодействие при выполнении встроенного действия.

При использовании самоподписных и (или) недоверенных сертификатов параметр должен быть активирован.

#### Метод

HTTP-метод, который будет использоваться при запросе на вебхук бэкенда. Для встроенных действий метод определяется автоматически в зависимости от типа действия.

#### Формат тела запроса

Для вебхук-действий доступен выбор формата отправки тела запроса:

- **JSON** (по умолчанию) — тело запроса отправляется в формате JSON с заголовком `Content-Type: application/json`.
- **Form URL Encoded** — тело запроса отправляется в формате `application/x-www-form-urlencoded`. В этом формате поддерживаются только плоские структуры ключ-значение, где все значения преобразуются в строки. Вложенные объекты и массивы не поддерживаются.

{{< alert level="info" >}}
При выборе формата Form URL Encoded тело запроса должно содержать только плоские ключ-значение пары. Например:

```yaml
token: {{ .credentials.token }}
```

Вложенные структуры и массивы в этом формате не поддерживаются.
{{< /alert >}}

#### Расширенное логирование

Для вебхук-действий доступна опция **расширенное логирование**, которая включает детальное логирование всех деталей HTTP-запроса и ответа:

- URL запроса
- HTTP-метод
- HTTP-заголовки (включая токены)
- Тело запроса
- Статус код ответа
- HTTP-заголовки ответа
- Тело ответа

При включенной опции все эти данные записываются в лог выполнения действия. При выключенной опции логирование выполняется в стандартном режиме.

{{< alert level="warning" >}}
Включение расширенного логирования может привести к записи конфиденциальной информации (токены, пароли и т.д.) в логи. Используйте эту опцию с осторожностью и только при необходимости отладки.
{{< /alert >}}

#### Headers

Headers — HTTP-заголовки в формате ключ-значение, которые будут добавлены в запрос к вебхуку бэкенда. Для встроенных действий заголовки добавляются автоматически в зависимости от типа действия.

### Обновление сущности

#### Обновление параметров сущности

После выполнения каждого действия результат (как правило, ответ от инфраструктурной системы) записывается в поле **response**. Если включена опция **обновление параметров сущности**, то на основании данных из **response** действие обновляет параметры сущности в соответствии с правилами обновления.  

Например, при выполнении действия «Создание проекта в GitLab» в поле **response** будет записана спецификация созданного проекта со следующей структурой:  

```json
{
  "id": "1",
  "...": "..."
}
```

Если после создания проекта в GitLab необходимо сразу заполнить параметр `repository_id` сущности, для которой этот проект был создан, в правилах обновления следует использовать следующую конструкцию:

* Источник: `{{ .response.id }}`.
* Параметр сущности: `repository_id`.

#### Обновление учётных данных пользователя

После выполнения действия результат записывается в поле **response**. Если включена опция **обновление учётных данных пользователя**, то на основании данных из **response** действие автоматически обновляет учётные данные пользователя в соответствии с правилами обновления.

Например, при выполнении действия, которое возвращает новый API-ключ в ответе:

```json
{
  "apiKey": "new-api-key-12345",
  "...": "..."
}
```

Чтобы автоматически обновить учётные данные пользователя, укажите в правилах обновления:

* **Источник**: `{{ .response.apiKey }}` — шаблон для получения значения из ответа действия.
* **Тип учётных данных**: выбор типа учётных данных, которые будут обновлены.

##### Выбор пользователя для обновления учётных данных

По умолчанию учётные данные обновляются для пользователя, который запустил действие (инициатора). Чтобы обновить учётные данные другого пользователя, включите опцию **обновлять учётные данные конкретного пользователя** и выбрать нужного пользователя.

{{< alert level="info" >}}
Обновление учётных данных выполняется только после успешного выполнения действия. Если действие завершилось с ошибкой, учётные данные не обновляются.
{{< /alert >}}

#### Создание связей сущностей

Если опция **создание связей сущностей** включена, то после выполнения действия для выбранной сущности будут автоматически созданы новые связи согласно заданным правилам. Для каждого ресурса можно определить свой набор правил.

При создании связи задаются родительский и дочерний ресурсы. Поиск сущностей выполняется в зависимости от указанного идентификатора: по родительскому или дочернему ресурсу.
В одном правиле следует указывать только один идентификатор. При одновременном указании родительского и дочернего идентификаторов поиск выполняется по родительскому ресурсу.

### Безопасность

#### Подтверждение перед запуском

Для действий может быть настроено обязательное подтверждение и количество подтверждающих перед запуском. В этом случае действие не будет выполнено до тех пор, пока не будет получено заданное количество подтверждений от заданных пользователей.

Посмотреть текущее количество подтвердивших и список тех, от кого ожидается подтверждение, можно в таблице запуска действий для каждой сущности.

Если подтверждение требуется от конкретного пользователя, ему будет отправлено уведомление в интерфейсе платформы.

#### Учетная запись для запуска действия

Для доступа к внешним инфраструктурным сервисам по умолчанию используются учетные данные пользователя, который запустил действие. При этом существует возможность в явном виде указать, что действие будет запускаться с использованием учетных данных конкретной учетной записи.

Для действий, которые предполагается запускать в качестве события автоматизации, указание учетной записи для запуска является обязательным условием.

#### Учетные данные

Для встроенных действий платформа заранее определяет перечень необходимых учетных данных. Идентификаторы этих учетных данных подгружаются при выборе встроенного бэкенда. Для каждого из идентификаторов необходимо выбрать, какой тип учетных данных будет использоваться.

Для вебхук-действий обращение к учетным данным возможно в теле запроса с использованием конструкции `{{ .credentials.<идентификатор типа учетных данных> }}`.

## Запуски действий

### Записи запусков действий

При каждом запуске действия создается запись, в которой указан инициатор запуска, статус выполнения и подробный лог. Записи запущенных действий для каждой сущности можно посмотреть в карточке сущности на вкладке «Запуски действий». Если для запуска действия необходимо подтверждение, оно выполняется в этой же вкладке.

Запись о запуске действия можно удалить, либо перезапустить действие. При перезапуске создается новая запись запуска.

### Логирование запусков

Для каждого запуска действия создается запись в БД, содержащая полный лог выполнения.

Параметр `actions.logging.enabled` в конфигурационном файле DDP позволяет выводить в stdout, либо скрывать логи запуска действия. При значении `true` логи запуска будут выводиться в stdout, при значении `false` логи выводиться не будут.

{{< alert level="info" >}}
Записи в БД с полным логом запуска действия создаются независимо от значения параметра `actions.logging.enabled`.
{{< /alert >}}

### Статусы действий

Для каждого запуска действия создается запись о его статусе. Статусы могут быть следующими:

- **Created** — запись создана, но действие еще не было запущено.
- **Unapproved** — действие ожидает подтверждения.
- **Running** — действие выполняется.
- **Failed** — действие завершилось неуспешно.
- **Update failed** — действие выполнено, но обновить параметры сущности не удалось.
- **Success** — действие завершилось успешно.
- **Retrying** — действие завершилось неуспешно, выполняется попытка перезапуска.
