---
title: Обзор
weight: 10
---

Действия — механизм, позволяющий пользователям платформы взаимодействовать с внешними по отношению к платформе инфраструктурными сервисами. Например:

- Создавать в Gitlab проекты, переменные, ветки либо теги для проектов.
- Создавать ресурсы в Kubernetes.
- Создавать секреты в Deckhouse Stronghold, либо в HashiCorp Vault.
- Создавать проекты в SonarQube, DefectDojo, и других системах.
- Создавать топики и ACL в Kafka.

Каждое действие может быть привязано к одному или нескольким ресурсам и может быть запущено для любой сущности данных ресурсов.

## Конфигурация

### Основная информация

Для каждого действия при создании или изменении указывается основная информация:

- **Название** (обязательно) — название действия в произвольном формате.
- **Идентификатор** (обязательно) — идентификатор действия. Генерируется автоматически из названия.
- **Ресурс** (опционально) — один или несколько ресурсов, для которых будет доступен запуск действия.
- **Иконка** (опционально) — иконка, которая будет отображаться в карточке действия.
- **Владелец** (опционально) — учетная запись пользователя, отвечающего за конфигурацию и работоспособность действия.
- **Команда владелец** (опционально) — команда, отвечающая за конфигурацию и работоспособность действия.
- **Теги** (опционально) — теги, которые могут помогать в понимании того, зачем и когда используется действие.
- **Описание** (опционально) — описание действия в Markdown, которое будет отображаться при запуске действия или сценария, содержащего действие.

### Пользовательская форма

#### Параметры

В разделе «Пользовательская форма» указываются параметры действия, которые будут доступны для заполнения при запуске действия. Типы параметров описаны в документации в разделе «Параметры».

Для каждого параметра доступен выбор следующих опций:

- **Редактируемый** — значение редактируемых параметров можно изменять при запуске действия. В случае, если параметр нередактируемый, изменение его значения при запуске действия будет недоступно.
- **Обязательный** — обязательные параметры, значение которых необходимо заполнить при запуске действия.
- **Скрытый** — скрытые параметры не будут появляться в пользовательской форме при запуске действия.

Для каждого параметра можно задать значение по умолчанию, которое будет подставляться в пользовательскую форму при запуске действия.

{{< alert level="info" >}}
Для нередактируемых или скрытых параметров рекомендуется всегда указывать значение по умолчанию, так как у пользователя, запускающего действие, нет возможности изменить их значения.
{{< /alert >}}

Описание каждого параметра будет отображаться при запуске действия при нажатии на кнопку со значком «info». Поэтому рекомендуется всегда заполнять описание параметра для упрощения понимания, зачем он необходим.

В качестве значений для пользовательской формы возможно использование шаблонных функций [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax). Например, выражение `{{ .entity.name }}`, заданное в качестве значения параметра, будет означать, что при запуске действия подставится название сущности, для которой запускается действие.

#### Условия параметров

Параметры могут быть скрыты или показаны в пользовательской форме в зависимости от значения другого параметра типа `Boolean`. Настройка скрытия или показа параметров осуществляется в разделе «Условия параметров».

### Backend

#### Тип

Backend для действия может быть одного двух типов:

- **Встроенный (BuiltIn)** — основная логика действия выполняется внутри платформы.
- **Webhook** — основная логика действия выполняется сторонным сервисом, куда отправляется webhook.

#### Встроенный Backend

При выборе встроенного backend будет предложено указать, какой именно встроенный backend должен использоваться. В зависимости от этого будет сгенерирован пример тела запроса действия и учетные данные, которые необходимы для запуска.

#### Маскировать поля действия

Для каждого действия можно настроить маскировку полей, содержащих потенциально конфиденциальную информацию.

При установке флага **маскировать поля действия** в записях действия будут скрыты:

- Поле `body` (тело запроса).
- Поле `response` (ответ, который генерируется после выполнения действия).
- Значение всех заполненных параметров.

#### Количество перезапусков

В случае, если действие завершилось неуспешно, оно может быть автоматически перезапущено. Параметр **количество перезапусков** задает максимальное количество автоматических перезапусков действия.

#### Базовая задержка (сек.)

Параметр **базовая задержка** задает интервал между попытками перезапуска действия. Интервал увеличивается при каждом перезапуске, например, если базовая задержка задана в 2 секунды, то первая попытка перезапуска действия будет через 2 секунды, вторая попытка через 4 секунды, третья - через 8 секунд и так далее.

#### Пример тела запроса

Каждое действие отправляет HTTP-запрос на встроенный бэкенд, либо на URL webhook backend. В подавляющем большинстве случаев запрос должен содержать тело, в котором описывается спецификация данного запроса.

Для встроенных backend при редактировании действия доступен пример тела запроса.

#### Тело запроса

В тело запроса действия могут быть подставлены параметры из пользовательской формы в формате [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax) с использованием синтаксиса YAML.

Пример:

```yaml
project_id: {{ .project_id }}
```

При подобном теле запроса конструкция `{{ .project_id }}` будет заменена на значение параметра **project_id**, которое, в свою очередь, будет браться из пользовательской формы.

#### Итоговое тело запроса

Поле **итоговое тело запроса** показывает, как будет выглядеть запрос после форматирования. При валидном JSON будет работать подсветка синтаксиса. При отсутствии подсветки синтаксиса рекомендуется обратить внимание на корректность формирования тела запроса.

#### URL

Для любого webhook действия в поле **URL** указывается URL стороннего backend, на который будет отправлен запрос.

Для встроенных действий в поле **URL** может указываться URL инфраструктурного сервиса, с которым будет происходить взаимодействие, либо данное поле может оставаться пустым. Подробности указаны в описании конкретных встроенных действий.

#### Выключить проверку SSL

Параметр определяет, будет ли проверяться SSL-сертификат backend при выполнении webhook действия, либо SSL-сертификат инфраструктурного сервиса с которым происходит взаимодействие при выполнении встроенного действия. В случае использования самоподписных и/или недоверенных сертификатов параметр должен быть активирован.

#### Метод

HTTP-метод, который будет использоваться при запросе на webhook backend. Для встроенных действий метод определяется автоматически в зависимости от типа действия.

#### Headers

HTTP-хедеры в формате ключ-значение, которые будут добавлены в запрос на webhook backend. Для встроенных действий хедеры добавляются автоматически в зависимости от типа действия.

### Обновление сущности

#### Обновление параметров сущности

После выполнения каждого действия результат (как правило, ответ от инфраструктурной системы) записывается в поле **response**. Если включена опция **обновление параметров сущности**, то на основании данных из **response** действие обновляет параметры сущности в соответствии с правилами обновления.  

Например, при выполнении действия «Создание проекта в GitLab» в поле **response** будет записана спецификация созданного проекта со следующей структурой:  

```json
{
  "id": "1",
  "...": "..."
}
```

Если после создания проекта в GitLab необходимо сразу заполнить параметр `repository_id` сущности, для которой этот проект был создан, в правилах обновления следует использовать следующую конструкцию:

* Источник: `{{ .response.id }}`
* Параметр сущности: `repository_id`

#### Создание связей сущностей

Если опция **создание связей сущностей** включена, то после выполнения действия для выбранной сущности будут автоматически созданы новые связи согласно заданным правилам. Для каждого ресурса можно определить свой набор правил.

**Важно:** при создании связи ресурсов задаётся родительский и дочерний ресурс. при указании идентификатора родительской сущности, поиск будет произведен только по сущностям из родительского ресурса. Если указать идентификатор дочерней сущности, то поиск будет произведен только по сущностям дочернего ресурса. В рамках создания правила необходимо указывать либо родительский идентификатор, либо дочерний. При одновременном указании в рамках одного правила обоих идентификаторов, поиск будет производиться только по родительскому ресурсу.

### Безопасность

#### Подтверждение перед запуском

Действиям можно назначать подтверждающих и их количество. В случае, если действие необходимо подтвердить, оно не будет выполняться до того момента, пока не будет собрано необходимое количество подтверждающих.

Посмотреть текущее количество подтвердивших и список тех, от кого ожидается подтверждение, можно в таблице запуска действий для каждой сущности.

При этом, если подтверждение ожидается от конкретного пользователя, то данному пользователю будет выведено уведомление в верхней панели (иконка колокольчика).

#### Учетная запись для запуска действия

Для доступа к внешним инфраструктурным сервисам по умолчанию используются учетные данные пользователя, который запустил действие. При этом существует возможность в явном виде указать, что действие будет запускаться с использованием учетных данных конкретной учетной записи.

Для действий, которые предполагается запускать в качестве события автоматизации, указание учетной записи для запуска является обязательным условием.

#### Учетные данные

Для встроенных действий заранее известно, какие учетные данные понадобятся для их запуска. Идентификаторы этих учетных данных подгружаются при выбора встроенного backend. Для каждого из идентификаторов необходимо выбрать, какой тип учетных данных будет использоваться.

Для webhook действий обращение к учетным данным возможно в теле запроса с использованием конструкции `{{ .credentials.<идентификатор типа учетных данных> }}`.

## Запуски действий

### Записи запусков действий

При каждом запуске действия создается запись, в которой указан инициатор запуска, статус выполнения и подробный лог запуска. Записи запущенных действий для каждой сущности можно посмотреть в карточке сущности во вкладке `Запуски действий`. Если для запуска действия необходимо подтверждение, то подтвердить запуск также можно во вкладке `Запуски действий`.

Каждую запись о запуске действия можно удалить, либо перезапустить действие. При этом при перезапуске будет создана новая запись.

### Логирование запусков

Для каждого запуска действия создается запись в БД, содержащая полный лог выполнения.

Параметр `actions.logging.enabled` в конфигурационном файле DDP позволяет выводить в stdout, либо скрывать логи запуска действия. При значении `true` логи запуска будут выводиться в stdout, при значении `false` логи выводиться не будут.

{{< alert level="info" >}}
Записи в БД с полным логом запуска действия создаются независимо от значения параметра `actions.logging.enabled`.
{{< /alert >}}

### Статусы действий

Для каждого запуска действия создается запись, которая может иметь один из следующих статусов:

- **Created** — запись создана, но действие еще не было запущено.
- **Unapproved** — действие ожидает подтверждения.
- **Running** — действие выполняется.
- **Failed** — действие завершилось неуспешно.
- **Update failed** — действие выполнено, но обновить параметры сущности не удалось.
- **Success** — действие завершилось успешно.
- **Retrying** — действие завершилось неуспешно, выполняется попытка перезапуска.
