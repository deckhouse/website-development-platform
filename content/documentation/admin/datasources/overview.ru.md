---
title: Обзор
weight: 10
---


Источники данных — механизм DDP, который позволяет синхронизировать информацию из внешних инфраструктурных систем (например, GitLab, либо Kubernetes) и преобразовывать данную информацию в параметры той или иной сущности.

Также источники данных позволяют:

* Создавать новые сущности.
* Удалять сущности, которые были удалены из внешних инфраструктурных систем.
* Создавать связи между сущностями.

Каждый источник данных привязан к определенному ресурсу, и, соответственно, может оперировать сущностями только данного ресурса. При этом, связи могут создаваться между сущностями привязанного ресурса и любыми другими сущностями.

## Типы источников данных

* Встроенные (BuiltIn) — источники данных, для которых логика опроса инфраструктурных систем поставляется в рамках DDP
* Вебхуки (Webhooks) — см. страницу «Вебхуки».

## Правила источников данных

Для каждого источника данных администратором системы настраиваются правила, по которым будут:

* Создаваться новые сущности.
* Создаваться новые связи.
* Производиться поиск соответствующих сущностей для обновления их параметров.
* Производиться поиск сущностей для удаления.

Правила описываются в формате `"source": "target"`. Для описания правил используется синтаксис [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax).

В DDP реализованы 5 типов правил:

* Правила фильтрации (filter rules).
* Правила создания (create rules).
* Правила сопоставления (match rules).
* Правила обновления (update rules).
* Правила создания связей (create relation rules).

### Правила фильтрации

Правила фильтрации позволяют отсеивать по регулярному выражению элементы, которые будут участвовать в дальнейшей обработке. В поле «Источник» указывается поле обрабатываемой структуры в формате [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax). В поле «Правило» указывается регулярное выражение для фильтрации.

В случае наличия нескольких правил фильтрации, для дальнейшей обработки необходимо, чтобы элемент соответствовал каждому из них. В случае отсутствия правил фильтрации обрабатываться будут все элементы, полученные от внешней инфраструктурной системы.

Например, при следующем наборе данных, полученном от внешней инфраструктурной системы:

```json
[
  {
    "name": "first",
    "description": "first"
  },
  {
    "name": "second",
    "description": "second"
  }
]
```

и следующих правилах фильтрации:

```json
"filterRules": [
  {
    "source": "{{ .name }}",
    "pattern": "^first"
  }
]
```

обработка правилами создания, сопоставления и т.д. будет осуществляться только для первого элемента массива, у которого значение поля `name` соответствует `first`.

### Правила создания

Правила создания определяют, каким образом информация, полученная от бэкенда источника данных, будет использоваться при создании новых сущностей.

Например, при следующей спецификации одного из ресурсов внешней инфраструктурной системы, полученного через источник данных:

```yaml
...
metadata:
  name: example
  namespace: default
...
```

и следующих правилах создания:

```json
"match": [
  {
    "source": "{{ .metadata.name }}",
    "target": "Name"
  },
  {
    "source": "{{ .metadata.namespace }}-{{ .metadata.name }}",
    "target": "Slug"
  }
]
```

после синхронизации источника данных будет создана сущность, название (Name) которой будет иметь значение `example`, а идентификатор (Slug) — значение `default-example`.

### Правила сопоставления

Правила сопоставления определяют, каким образом производить поиск существующих, либо только что созданных источником данных сущностей для обновления их параметров.

### Правила обновления

Правила обновления определяют, какие параметры сущности стоит автоматически заполнять на основе спецификации соответствующего ресурса из внешней системы. Сущность, параметры которой необходимо заполнить, определяется на основе правил сопоставления.

### Правила создания связей

Правила создания связей определяют, какие связи создавать для сущности, которая соответствует правилам сопоставления. При задании правил создания связей заполняется:

* Связь ресурса.
* Поле из спецификации ресурса внешней инфраструктурной системы, на основании которого производить поиск связи.

Например, при следующей спецификации одного из ресурсов внешней инфраструктурной системы, полученного через источник данных:

```yaml
...
metadata:
  name: example
  namespace: default
...
```

и следующем правиле создания связей:

```json
"createRelations": [
  {
    "resourceRelationUuid": "<12345678-1234-5678-1234-567812345678>",
    "parentEntitySlug": "{{ .metadata.namespace }}",
    "childEntitySlug": ""
  }
]
```

будет:

* Среди сущностей, которые при создании связи были указаны как родительские, был произведен поиск той, идентификатор (slug) которой соответствует значению `default`. **Важно:** при создании связи ресурсов задаётся родительский и дочерний ресурс. при указании идентификатора родительской сущности, поиск будет произведен только по сущностям из родительского ресурса. Если указать идентификатор дочерней сущности, то поиск будет произведен только по сущностям дочернего ресурса. В рамках создания правила необходимо указывать либо родительский идентификатор, либо дочерний. При одновременном указании в рамках одного правила обоих идентификаторов, поиск будет производиться только по родительскому ресурсу.

* В случае существования сущности родительского ресурса с идентификатором `default`, создана связь между данной сущностью, и сущностью ресурса, к которому привязан источник данных, и которая соответствует правилам сопоставления

## Синхронизация

Каждый источник данных имеет несколько параметров настройки синхронизации:

* Периодическая синхронизация (enableSchedule) — включение или выключение периодической синхронизации.
* Периодичность запуска (scheduleExpression) — cron-выражение из 6 полей, определяющее интервал запуска периодической синхронизации.

При включенном параметре «Периодическая синхронизация» источник данных будет автоматически обновлять информацию из внешних инфраструктурных систем с интервалом, определенным в параметре «Периодичность запуска».

Также каждый источник данных может быть синхронизирован вручную в любой момент времени через веб-интерфейс (пункт `Синхронизировать` в меню источника данных), либо через API.

## Удаление сущностей

Каждый источник данных имеет несколько параметров удаления сущностей:

* Удаление несуществующих сущностей (deleteEntities).
* Удаление только сущностей, созданных этим источником данных (deleteOnlyOriginatedEntities).

При включении параметра «Удаление несуществующих сущностей» источник данных будет сравнивать список ресурсов, полученных из внешней инфраструктурной системы и список существующих сущностей ресурса. При обнаружении в DDP сущностей, которые отсутствуют в списке полученных, они будут удалены из DDP.

При включении параметра «Удаление только сущностей, созданных этим источником данных» источник данных будет дополнительно сравнивать, каким образом была создана сущность, которую необходимо удалить. Если сущность была создана этим источником данных, то она будет удалена, если нет, то источник данных перейдет к обработке следующей сущности в списке без удаления текущей.

Поиск создателя (origin) сущности производится по двум полям в спецификации сущности:

```json
{
    "origin": {
        "type": "<datasource | manual | webhook",
        "uuid": "12345678-1234-5678-1234-567812345678>"
    }
}
```

## Логирование запусков

Для каждого запуска источника данных создается запись в БД, содержащая полный лог выполнения. Максимальное количество подобных записей регулируется параметром «максимальное количество записей» в конфигурации источника данных. При достижении максимального количества старые записи будут удаляться.

Параметр `datasources.logging.enabled` в конфигурационном файле DDP позволяет выводить в stdout, либо скрывать логи синхронизации источника данных. При значении `true` логи будут выводиться в stdout, при значении `false` логи выводиться не будут.

{{< alert level="info" >}}
Записи в БД с полным логом запуска источника данных создаются независимо от значения параметра `datasources.logging.enabled`.
{{< /alert >}}

## Системная учетная запись

При настройке источника данных необходимо выбрать системную учетную запись для запуска синхронизации.

Реквизиты данной учетной записи будут использоваться источником данных для доступа к опрашиваемой инфраструктурной системе.

Помимо системной учетной записи необходимо указание того, какие ее реквизиты будут использованы при запуске источника данных. Для этого в секции «Безопасность / Учетные данные» добавляются новые учетные данные с определенным идентификатором.

Значение данного идентификатора может быть подставлено в конфигурацию источника данных с использованием синтаксиса [Go template](https://developer.hashicorp.com/nomad/tutorials/templates/go-template-syntax).

Например, если в Header для источника данных необходимо передать секретное значение с идентификатором `token`, то оно может быть указано в следующем виде:

```go
{{ .credentials.token }}
```
