---
title: Типы проверок статуса
---

## Prometheus

Правило типа **Prometheus** проверяет, соответствует ли указанная метрика заданному пороговому значению. В конфигурации указывается запрос PromQL, который должен возвращать результат типа Scalar или Vector с одним значением.

Поддерживается шаблонизация, например:

```go
avg(ingress_nginx_detail_request_seconds_sum{location="/{{ .entity.slug }}"})
```

В данном примере вместо выражения `{{ .entity.slug }}` подставится идентификатор сущности.

### Параметры конфигурации

| Название            | Описание                                                           | Возможные значения                     |
|---------------------|--------------------------------------------------------------------|----------------------------------------|
| Запрос              | Запрос в формате PromQL к метрике в Prometheus                     |                                        |
| Оператор            | Оператор сравнения между результатом запроса и пороговым значением | Equal, NotEqual, LessThan, GreaterThan |
| Порог               | Пороговое значение для сравнения с результатом запроса             |                                        |

> Для проверки каждой сущности выполняется отдельный запрос к Prometheus. Рекомендуется учитывать это при планировании нагрузки на систему.

### Авторизация

Конфигурация авторизации описана в разделе [внешний сервис Prometheus](../external-services/#prometheus).

## Gitlab Pipeline

Правило типа **GitlabPipeline** проверяет, соответствует ли статус последнего pipeline в Gitlab для выбранного Ref (ветка или тег) заданному статусу.

Во всех текстовых полях поддерживается шаблонизация, например, при подобном выражении в поле `Ref`:

```go
{{ .entity.properties.mainBranch }}
```

во время проверки подставится значение параметра `mainBranch` проверяемой сущности.

### Параметры конфигурации

| Название            | Описание                                                    | Возможные значения                                                                                                |
|---------------------|-------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| ID проекта          | ID проекта в Gitlab                                         |                                                                                                                   |
| Ref                 | Ветка или тег для которых будет искаться последний pipeline |                                                                                                                   |
| Статус              | Статус pipeline, который будет считаться успешным           | created, waiting_for_resource, preparing, pending, running, success, failed, canceled, skipped, manual, scheduled |

> Для проверки каждой сущности выполняется отдельный запрос к Gitlab. Рекомендуется учитывать это при планировании нагрузки на систему.

### Авторизация

Конфигурация авторизации описана в разделе [внешний сервис GitLab](../external-services/#gitlab).

## DefectDojo Findings

Правило типа **DefectDojoFindings** выполняет проверку по количеству активных уязвимостей различной критичности (severity) для заданного продукта в DefectDojo.  

Проверка проводится по условиям в блоке `conditions`, где можно указать ожидаемое количество уязвимостей для каждой severity и оператор сравнения (например, Critical < 5).

Во всех текстовых полях поддерживается шаблонизация. Например, можно подставить название продукта из параметров сущности:

```go
{{ .entity.properties.defectdojo_product_key }}
```

### Параметры конфигурации

| Название            | Описание                                                 | Возможные значения  |
|---------------------|----------------------------------------------------------|---------------------|
| Название продукта   | Идентификатор продукта в DefectDojo                      |                     |
| Условия             | Условия для сравнения количества уязвимостей по severity |                     |

#### Условия

Каждое условие представляет объект следующей формы:

```yaml
conditions:
  - severity: Critical
    operator: "<"
    value: "5"
  - severity: High
    operator: "<="
    value: "10"
```

| Поле                | Описание                       | Возможные значения                       |
|---------------------|--------------------------------|------------------------------------------|
| Уровень критичности | Уровень критичности            | Total, Critical, High, Medium, Low, Info |
| Оператор            | Оператор сравнения             | ==, !=, <, <=, >, >=                     |
| Значение            | Целевое значение для сравнения |                                          |

### Авторизация

Конфигурация авторизации описана в разделе [внешний сервис DefectDojo](../external-services/#defectdojo).

## CodeScoring Vulnerabilities

Правило типа **CodeScoringVulnerabilities** выполняет проверку по количеству уязвимостей различной критичности (severity) для заданного проекта в CodeScoring.

Проверка проводится по условиям в блоке `conditions`, где можно указать ожидаемое количество уязвимостей для каждой severity и оператор сравнения. Поддерживается проверка как по CVSS2, так и по CVSS3 метрикам.

Во всех текстовых полях поддерживается шаблонизация. Например, можно подставить ID проекта из параметров сущности:

```go
{{ .entity.properties.codescoring_project_id }}
```

### Параметры конфигурации

| Название            | Описание                                                       | Возможные значения |
|---------------------|----------------------------------------------------------------|--------------------|
| ID проекта          | Идентификатор проекта в CodeScoring                            |                    |
| Условия             | Условия для сравнения количества уязвимостей по severity       |                    |

#### Условия

Каждое условие представляет объект следующего формата:

```yaml
conditions:
  - severity: CRITICAL
    operator: "<"
    value: "5"
    cvss: "cvss3"
  - severity: HIGH
    operator: "<="
    value: "10"
    cvss: "cvss2"
```

| Поле                | Описание                       | Возможные значения                                                                        |
|---------------------|--------------------------------|-------------------------------------------------------------------------------------------|
| Уровень критичности | Уровень критичности            | Для CVSS3: CRITICAL, HIGH, MEDIUM, LOW, NONE, UNKNOWN. Для CVSS2: HIGH, MEDIUM, LOW, NONE |
| Оператор            | Оператор сравнения             | ==, !=, <, <=, >, >=                                                                      |
| Значение            | Целевое значение для сравнения |                                                                                           |
| CVSS                | Версия CVSS метрики            | cvss2, cvss3                                                                              |

### Авторизация

Конфигурация авторизации описана в разделе [внешний сервис CodeScoring](../external-services/#codescoring).

## SonarQube Metrics

Правило типа **SonarqubeMetrics** выполняет проверку по метрикам проекта в SonarQube на основании заданных условий.  

Проверка выполняется с использованием REST API вызова SonarQube `/api/measures/component`, где сравниваются текущие значения указанных метрик c ожидаемыми значениями, заданными в разделе «Условия».

Во всех текстовых полях поддерживается шаблонизация, например, можно подставить ключ компонента из параметров сущности:

```go
{{ .entity.properties.sonarqube_project_key }}
```

### Параметры конфигурации

| Название            | Опциональность  | Описание                                                   | Возможные значения  |
|---------------------|-----------------|------------------------------------------------------------|---------------------|
| Ключ проекта        | **Обязательно** | Идентификатор проекта в SonarQube                          |                     |
| Ветка               | Опционально     | Ветка проекта для которой будут браться метрики            |                     |
| Условия             | **Обязательно** | Условия для сравнения метрик в SonarQube                   |                     |

#### Условия

Каждое условие представляет объект следующей формы:

```yaml
conditions:
  - metric: coverage
    operator: "<"
    value: "5"
  - metric: bugs
    operator: "<="
    value: "10"
```

| Поле      | Описание                                                 | Возможные значения                                                     |
|-----------|----------------------------------------------------------|------------------------------------------------------------------------|
| Метрика   | Метрика SonarQube. В конфигурации указывается Metric key | См. список метрик в официальной документации SonarQube                 |
| Оператор  | Оператор сравнения                                       | ==, !=, <, <=, >, >=                                                   |
| Значение  | Целевое значение для сравнения                           |                                                                        |

[Список возможных метрик](https://docs.sonarsource.com/sonarqube-server/latest/user-guide/code-metrics/metrics-definition) для текущей версии SonarQube.

### Авторизация

Конфигурация авторизации описана в разделе [внешний сервис SonarQube](../external-services/#sonarqube).

## SonarQube Quality Gate

Правило типа **SonarqubeQualityGate** проверяет статус Quality Gate проекта в SonarQube. Проверка выполняется с использованием REST API вызова SonarQube `/api/qualitygates/project_status`.

Правило возвращает `true` (выполняется), если Quality Gate проекта имеет статус `OK`, и `false` (не выполняется) во всех остальных случаях (статусы `WARN`, `ERROR`, `NONE`).

Во всех текстовых полях поддерживается шаблонизация, например, можно подставить ключ проекта из параметров сущности:

```go
{{ .entity.properties.sonarqube_project_key }}
```

### Параметры конфигурации

| Название            | Опциональность  | Описание                                                   | Возможные значения  |
|---------------------|-----------------|------------------------------------------------------------|---------------------|
| Ключ проекта        | **Обязательно** | Идентификатор проекта в SonarQube                          |                     |
| Ветка               | Опционально     | Ветка проекта для которой будет проверяться Quality Gate. Если не указана, проверяется основная ветка |                     |

> Для проверки каждой сущности выполняется отдельный запрос к SonarQube. Рекомендуется учитывать это при планировании нагрузки на систему.

### Авторизация

Конфигурация авторизации описана в разделе [внешний сервис SonarQube](../external-services/#sonarqube).

## URL

Правило типа **URL** выполняет проверку доступности HTTP/HTTPS-эндпоинта: формируется запрос по заданным параметрам, затем результат оценивается по одному или нескольким **условиям** (выражениям Go template). Условия могут проверять код ответа, заголовки, тело ответа и параметры сущности.

Во всех строковых полях используется шаблонизация с применением сущности, например:

```go
{{ .entity.slug }}
```

Это можно использовать, например, для динамического формирования URL и/или тела запроса.

### Параметры конфигурации

| Название              | Опциональность  | Описание                                                                                      | Примеры               |
|-----------------------|-----------------|-----------------------------------------------------------------------------------------------|-----------------------|
| URL                   | **Обязательно** | Полный адрес ресурса, к которому выполняется запрос                                           | `https://example.com` |
| Метод                 | Опционально     | HTTP-метод запроса                                                                            | GET, POST             |
| Тело запроса          | Опционально     | Тело запроса в YAML (после шаблонизации сериализуется в JSON)                                 |                       |
| Условия               | Опционально     | Одно или несколько выражений Go template для проверки ответа                                  | см. ниже              |
| Режим условия         | Опционально     | При нескольких условиях: **AllOf** (все должны выполниться) или **AnyOf** (достаточно одного) | AllOf, AnyOf          |
| Не логировать значение| Опционально     | Не сохранять значения, полученные в ответ на запрос                                           |                       |

Если условия не заданы, используется одно условие по умолчанию: `{{ eq .status.code 200 }}`.

### Данные для условий

В выражениях условий доступны:

- **`.status`** — данные ответа: `.status.code` (код HTTP), `.status.status` (строка статуса), `.status.headers` (заголовки ответа), `.status.contentLength`. Поле **`.status.headers`** — это карта «имя заголовка → массив строк» (все значения заголовка; имена приводятся к нижнему регистру). Примеры: первый элемент заголовка — `{{ index (index .status.headers "content-type") 0 }}`; перебор значений — `{{ range index .status.headers "set-cookie" }}...{{ end }}`.
- **`.response`** — тело ответа, приведённое к типам (если ответ в JSON).
- **`.entity`** — параметры проверяемой сущности.

Примеры условий:

```go
{{ eq .status.code 200 }}
{{ eq (index (index .status.headers "content-type") 0) "application/json" }}
{{ gt .status.contentLength 0 }}
```

### Обработка шаблонов

- Поддерживается шаблонизация в полях, включая `URL` и `Тело запроса`.
- Значения могут браться из .entity, включая вложенные свойства (например, `{{ .entity.properties.id }}`).
- Также поддерживается шаблонизация в заголовках и других текстовых полях.

### Пример тела запроса

Поле `Тело запроса` описывается в YAML. После раскодирования и шаблонизации оно будет сериализовано в JSON и отправлено.

Например:

```yaml
id: "{{ .entity.id }}"
name: "{{ .entity.name }}"
```

### Проверка результата

Результат проверки считается успешным, если в зависимости от режима условия выполняются все условия (AllOf) или хотя бы одно (AnyOf). Если при вычислении условия возникает ошибка (например, тело ответа не JSON, а в условии используется `.response`), проверка завершается с ошибкой.

Учитывайте, что `URL` также может быть динамическим и шаблонизироваться на основе параметров сущности:

```go
https://api.example.com/{{ .entity.slug }}/health
```
