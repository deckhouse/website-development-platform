# WF for deploying to test/stage envs on PR label 'deploy/test' or 'deploy/stage'

name: Deploy to dev environments

on:
  pull_request_target:
    types:
      - labeled

# Cancel in-progress jobs for the same tag/branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.label.name }}-deploy
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  deploy:
    name: Deploy to ${{ github.event.label.name }}
    runs-on: ubuntu-latest
    if: >
      (github.event.label.name == 'deploy/test' || github.event.label.name == 'deploy/stage')
      && startsWith(github.repository, 'deckhouse/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: recursive
          fetch-depth: 0

      - name: Extract environment
        id: env
        run: |
          LABEL="${{ github.event.label.name }}"
          ENV="${LABEL#deploy/}"
          echo "env=$ENV" >> $GITHUB_OUTPUT

      - name: Validate that Environment variable set
        run: |
          if [ -z "${{ steps.env.outputs.env }}" ]; then
            echo "::error::Can't determine environment name."
            exit 1
          fi
          echo "Environment: ${{ steps.env.outputs.env }}"

      - name: Create deployment comment
        id: comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const env = '${{ steps.env.outputs.env }}';
            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## üöÄ Deployment Started\n\n**Environment:** \`${env}\`\n\n_This comment will be updated with deployment status._`
            });
            console.log(`Created comment: ${comment.data.id}`);
            return comment.data.id;

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@v2
        with:
          url: https://seguro.flant.com
          path: github
          role: deckhouse-web-products
          method: jwt
          jwtGithubAudience: github-access-aud
          secrets: |
            projects/data/6db2f1ee-9b6f-4f4f-8381-2fb43060478a/github/registry_host DECKHOUSE_DEV_REGISTRY_HOST | DECKHOUSE_DEV_REGISTRY_HOST ;
            projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken login | DECKHOUSE_DEV_REGISTRY_USER ;
            projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken password | DECKHOUSE_DEV_REGISTRY_PASSWORD ;
            projects/data/6db2f1ee-9b6f-4f4f-8381-2fb43060478a/github/documentation_deploy_secret KUBECONFIG_BASE64_DEV | KUBECONFIG_BASE64_DEV ;

      - name: Check dev registry credentials
        id: check_dev_registry
        env:
          HOST: ${{steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_HOST}}
        run: |
          if [[ -n $HOST ]]; then
            echo "has_credentials=true" >> $GITHUB_OUTPUT
            echo "web_registry_path=${{steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_HOST }}/deckhouse/site" >> $GITHUB_OUTPUT
          fi

      - name: Login to dev registry
        uses: docker/login-action@v3
        if: ${{ steps.check_dev_registry.outputs.has_credentials == 'true' }}
        with:
          registry: ${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_HOST }}
          username: ${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_USER }}
          password: ${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_PASSWORD }}
          logout: false

      - name: Deploy to ${{ steps.env.outputs.env }}
        uses: werf/actions/converge@v2
        id: deploy
        with:
          channel: beta
          kube-config-base64-data: ${{ steps.secrets.outputs.KUBECONFIG_BASE64_DEV }}
        env:
          WERF_ENV: ${{ steps.env.outputs.env }}
          WERF_REPO: ${{ steps.check_dev_registry.outputs.web_registry_path }}
          WERF_SET_URL: "global.url=deckhouse.${{ steps.env.outputs.env }}.flant.com"
          WERF_SET_URL_RU: "global.url_ru=deckhouse.ru.${{ steps.env.outputs.env }}.flant.com"

      - name: Update comment - deployment succeeded
        if: success() && steps.comment.outputs.result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const env = '${{ steps.env.outputs.env }}';
            const commentId = ${{ steps.comment.outputs.result }};
            if (!commentId) {
              console.log('No comment ID available, skipping update');
              return;
            }
            const repoName = context.repo.repo;
            const appName = repoName.startsWith('website-') ? repoName.replace(/^website-/, '') : repoName;
            const urlEn = `https://deckhouse.${env}.flant.com/products/${appName}/documentation/`;
            const urlRu = `https://deckhouse.ru.${env}.flant.com/products/${appName}/documentation/`;
      
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `## ‚úÖ Deployment Succeeded\n\n**Environment:** \`${env}\`\n\n**Access URLs:**\n\n- üá¨üáß [English](${urlEn})\n- üá∑üá∫ [Russian](${urlRu})`
            });
            console.log(`Updated comment ${commentId} with success status`);

      - name: Update comment - deployment failed
        if: failure() && steps.comment.outputs.result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const env = '${{ steps.env.outputs.env }}';
            const commentId = ${{ steps.comment.outputs.result }};
            if (!commentId) {
              console.log('No comment ID available, skipping update');
              return;
            }
      
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
      
            const job = jobs.data.jobs.find(j => j.name === 'deploy');
            const jobId = job ? job.id : null;
      
            let logsUrl;
            if (jobId) {
              logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/job/${jobId}`;
            } else {
              logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            }
      
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `## ‚ùå Deployment Failed\n\n**Environment:** \`${env}\`\n\nPlease check the [workflow logs](${logsUrl}) for details.`
            });
            console.log(`Updated comment ${commentId} with failure status`);

      - name: Remove deploy label
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = context.payload.label.name;
            if (label && (label === 'deploy/test' || label === 'deploy/stage')) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: label
              });
              console.log(`Removed label: ${label}`);
            }

