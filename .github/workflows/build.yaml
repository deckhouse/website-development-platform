name: Build

on:
  push:
    branches-ignore:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Hugo Site
    concurrency:
      group: build-${{ github.event.pull_request.head.ref || github.ref_name }}
      cancel-in-progress: true
    container:
      image: hugomods/hugo:debian-ci-0.150.1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Mark repository as safe
        run: git config --global --add safe.directory '${{ github.workspace }}'

      - name: Build Hugo site
        run: hugo --minify --enableGitInfo=false

      - name: Extract app name
        id: app_name
        shell: bash
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"
          echo "Repository name: $REPO_NAME"
          if [[ "$REPO_NAME" =~ ^website- ]]; then
            APP_NAME="${REPO_NAME#website-}"
          else
            APP_NAME="$REPO_NAME"
          fi
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "App name: $APP_NAME"

      - name: Rewrite URLs to remove /products/<APP>/ prefix
        run: |
          APP_NAME="${{ steps.app_name.outputs.app_name }}"
          find ./public/en ./public/ru -type f -name "*.html" -exec sed -i "s|/products/${APP_NAME}/|/|g" {} +

      - name: Upload site artifacts
        uses: actions/upload-artifact@v4
        with:
          name: built-site
          path: public/
          retention-days: 1

  check-links:
    runs-on: ubuntu-latest
    name: Check Links
    needs: build
    steps:
      - name: Download site artifacts
        uses: actions/download-artifact@v4
        with:
          name: built-site
          path: .

      - name: Install htmltest
        run: |
          curl https://htmltest.wjdp.uk | bash

      - name: Create htmltest config
        run: |
          cat > .htmltest.yml << EOF
          IgnoreURLs:
            - "example.com"
            - "localhost"
            - "^/assets/"
            - "^/assets/js/"
            - "^/images/.+$"
            - "^/css/.+$"
            - "^/js/.+$"
          CheckMeta: false
          CheckLinks: false
          CheckMailto: false
          CheckTel: false
          CheckFavicon: false
          IgnoreInternalEmptyHash: true
          IgnoreCanonicalBrokenLinks: true
          EOF

      - name: Check links (English)
        id: check_links_english
        continue-on-error: true
        run: bin/htmltest -c .htmltest.yml ./en

      - name: Check links (Russian)
        id: check_links_russian
        continue-on-error: true
        run: bin/htmltest -c .htmltest.yml ./ru

      - name: Fail job if any link check failed
        if: always()
        run: |
          if [ "${{ steps.check_links_english.outcome }}" == "failure" ] || [ "${{ steps.check_links_russian.outcome }}" == "failure" ]; then
            echo "One or more link checks failed"
            exit 1
          fi
